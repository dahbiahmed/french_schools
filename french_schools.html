<!DOCTYPE html>
<html style="height: 100%;">
    <head>
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet' />
        <style>
            body { margin: 0; padding: 0; height: 100%; }
            #map { width: 100%; height: 100%; }
            .filter-panel {
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 1;
                padding: 10px;
                background: #fff;
                display: flex;
                flex-direction: column;
                gap: 10px;
                font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
                border-radius: 10px;
                width: 300px;
            }
            .filter-panel label {
                display: flex;
                flex-direction: column;
                font-size: 14px;
                color: #333;
            }
            .filter-panel input,
            .filter-panel select {
                padding: 5px;
                font-size: 14px;
                border-radius: 8px;
            }
            .mapboxgl-popup {
                max-width: 300px;
                font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            }
            .mapboxgl-popup-content {
                padding: 15px;
                border-radius: 10px;
            }
        
            @media (max-width: 600px) {
                .filter-panel {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    height: auto;
                    flex-direction: column;
                    padding: 10px;
                    border-radius: 0;
                    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                }
                .filter-panel label {
                    width: 100%; /* Ensure labels take full width */
                    margin: 5px 0; /* Reduce margin */
                }
                .filter-panel input,
                .filter-panel select {
                    width: calc(100% - 10px); /* Full width minus padding */
                }
            }
        </style>
    </head>
<body>

<div id='map'></div>
<div class="filter-panel">
    <label>
        Min IPS percentile: <span id="minIpsPercentileValue">0</span>
        <input type="range" id="minIpsPercentile" min="0" max="100" value="50" step="0.1">
    </label>
    <label>
        Statut:
        <select id="statut">
            <option value="">Public + Privé</option>
            <option value="privé sous contrat">privé sous contrat</option>
            <option value="public">public</option>
        </select>
    </label>
    <label>
        <a href="https://fr.wikipedia.org/wiki/Indice_de_position_sociale" target="_blank">Learn more about IPS</a>
    </label>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGFoYmlhaG1lZCIsImEiOiJjbHZlYmRrZ3kwN2t2MmpudmV5bnd0OTI3In0.qp6N0FK3t5LqZWy2DqUKsQ';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [1.888334, 46.603354],
    zoom: 6
});

// A simple hash function to convert a string into a color
function hashStringToColor(str) {
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    var color = '#';
    for (var i = 0; i < 3; i++) {
        var value = (hash >> (i * 8)) & 0xFF;
        color += ('00' + value.toString(16)).substr(-2);
    }
    return color;
}

// Fetch the GeoJSON data
fetch('paris_carte_scolaire.geojson')
    .then(response => response.json())
    .then(data => {
        // Add a color property to each feature based on the hash of the "libelle" property
        data.features.forEach(function(feature) {
            feature.properties.color = hashStringToColor(feature.properties.libelle);
        });

        // Add the source
        map.addSource('paris_carte_scolaire', {
            type: 'geojson',
            data: data
        });

        // Add the layer
        map.addLayer({
            id: 'paris_carte_scolaire',
            type: 'fill',
            source: 'paris_carte_scolaire',
            minzoom: 12,
            paint: {
                'fill-color': ['get', 'color'], // Use the assigned color
                'fill-opacity': 0.05
            }
        });
    });
// Fetch the JSON data from the file
fetch('schools_data.json')
    .then(response => response.json())
    .then(schools => {
        // Get the input elements
        var minIpsPercentileValue = document.getElementById('minIpsPercentileValue');
        var minIpsPercentileInput = document.getElementById('minIpsPercentile');
        var statutInput = document.getElementById('statut');

        // Function to update the map
        function updateMap() {
            // Get the current values of the inputs
            var minIpsPercentile = minIpsPercentileInput.value;
            var statut = statutInput.value;
            minIpsPercentileValue.textContent = minIpsPercentile;

            // Filter schools based on the inputs
            var filteredSchools = schools.filter(function(school) {
                return school.ips_percentile_global > minIpsPercentile &&
                    (statut === '' || school.prive_vs_public === statut);
            });

            // Convert the array of schools to a GeoJSON FeatureCollection
            var geojson = {
                type: 'FeatureCollection',
                features: filteredSchools.map(function(school) {
                    return {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [school.lon, school.lat]
                        },
                        properties: school
                    };
                })
            };

            // If the source already exists, update it
            if (map.getSource('schools')) {
                map.getSource('schools').setData(geojson);
            } else {
                // Otherwise, add the source
                map.addSource('schools', {
                    type: 'geojson',
                    data: geojson
                });

                // And add a layer for the schools
                map.addLayer({
                    id: 'schools',
                    type: 'circle',
                    source: 'schools',
                    paint: {
                        'circle-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'ips_percentile_global'],
                            0, 'red',
                            100, 'green'
                        ],
                        'circle-radius': 4,
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff'
                    }
                });

                // Add a popup when a point is clicked
                map.on('click', 'schools', function(e) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var school = e.features[0].properties;

                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(`
                        <h3>${school['nom_etablissement']}</h3>
                        <p><strong>Statut:</strong> ${school['prive_vs_public']}</p>
                        <p><strong>IPS Global Percentile:</strong> ${school['ips_percentile_global']}</p>
                        <p><strong>IPS Score:</strong> ${school['ips_score']}</p>
                        <p><strong>Commune:</strong> ${school['nom_commune']}</p>
                        <p><strong>Price per Square Meter:</strong> ${school['prix_metre_carre_commune']}</p>
                    `)
                    .addTo(map);
                });
            }
        }
        map.on('load', function() {
            if (map.getLayer('schools') && map.getLayer('pris_carte_scolaire')) {
                map.moveLayer('schools');
            }
        });
        // Update the map initially and whenever the inputs change
        updateMap();
        minIpsPercentileInput.addEventListener('input', updateMap);
        statutInput.addEventListener('change', updateMap);
        minIpsPercentileValue.textContent = minIpsPercentileInput.value;

    });
</script>

</body>
</html>